import type { Plugin } from 'esbuild'
import { writeFile } from 'node:fs/promises'
import process from 'node:process'

interface Options {
    prefix?: string
    declarationPath?: string
}
export function esbuildInjectEnv(options: Options): Plugin {
    return {
        name: 'gask-inject-env',
        setup(build) {
            if (!options.prefix) {
                return
            }
            const { defines, varsNames } = getEnvDefine(options.prefix)
            build.initialOptions.define = {
                ...build.initialOptions.define,
                ...defines,
            }

            if (options.declarationPath) {
                build.onEnd(async () => {
                    await writeDeclarationFile(options.declarationPath!, varsNames)
                    for (const name of varsNames) {
                        delete process.env[`${options.prefix}${name}`] // Clean up injected env vars for reloads
                    }
                })
            }
        },
    }
}

function getEnvDefine(prefix: string) {
    const defines: Record<string, string> = {}
    const varsNames: string[] = []
    for (const [key, value] of Object.entries(process.env)) {
        if (key.startsWith(prefix)) {
            const varName = key.replace(prefix, '')
            defines[`env.${varName}`] = JSON.stringify(value)
            varsNames.push(varName)
        }
    }
    return { defines, varsNames }
}

async function writeDeclarationFile(path: string, vars: string[]) {
    const varsLines = vars.map(v => `  ${v}: string;`).join('\n')
    const content = `// Auto-generated by Gask Build\n/* eslint-disable */\ndeclare const env: {\n${varsLines}\n};\n`
    await writeFile(path, content)
}
